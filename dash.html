<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Renatus Barber | Executive Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --barber-blue-main: #007bff;
            --barber-bg: #1a1c1e;
            --barber-text: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --font-sans: 'Montserrat', sans-serif;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --info: #007bff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--barber-bg); font-family: var(--font-sans); color: var(--barber-text); padding-bottom: 50px; }

        #login-screen { position: fixed; inset: 0; background: rgba(26, 28, 30, 0.98); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .login-card { background: var(--barber-bg); padding: 50px; border-radius: 40px; box-shadow: 20px 20px 60px var(--shadow-dark); text-align: center; border: 1px solid var(--glass-border); }

        #dash-content { display: block; padding: 30px 5%; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .logo-text { font-weight: 800; font-size: 1.2rem; color: var(--barber-blue-main); letter-spacing: 2px; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }

        .card-rb { 
            background: var(--glass-bg); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 35px; 
            box-shadow: 12px 12px 24px var(--shadow-dark);
            margin-bottom: 30px; border: 1px solid var(--glass-border);
        }

        .kpi-card { padding: 20px; text-align: center; }
        .kpi-value { font-size: 1.2rem; font-weight: 700; color: var(--barber-blue-main); display: block; margin-top: 5px; }
        .kpi-label { font-size: 0.55rem; font-weight: 800; opacity: 0.5; text-transform: uppercase; letter-spacing: 1px; }

        .section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--barber-blue-main); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: ''; width: 4px; height: 15px; background: var(--barber-blue-main); border-radius: 2px; }

        .kanban-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; align-items: start; }
        .kanban-column { background: rgba(255,255,255,0.02); border-radius: 25px; padding: 15px; min-height: 500px; border: 1px solid var(--glass-border); transition: background 0.3s; }
        .kanban-column.drag-over { background: rgba(255,255,255,0.08); }
        
        .col-header { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; color: #fff; margin-bottom: 15px; text-align: center; display: flex; justify-content: center; align-items: center; gap: 8px; position: sticky; top: 0; background: inherit; z-index: 1; padding: 5px 0; }
        .col-dot { width: 8px; height: 8px; border-radius: 50%; }

        .pedido-card { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 15px; margin-bottom: 12px; border: 1px solid var(--glass-border); cursor: grab; transition: transform 0.2s; position: relative; }
        .pedido-card:active { cursor: grabbing; transform: scale(0.95); }
        
        .status-select { padding: 8px; border-radius: 10px; border: none; font-size: 0.55rem; font-weight: 800; text-transform: uppercase; cursor: pointer; width: 100%; background: #2a2c2e; color: #fff; margin-top: 10px; }
        
        .client-name { font-size: 0.75rem; font-weight: 700; display: block; margin-bottom: 3px; }
        .time-tag { font-size: 0.6rem; color: var(--barber-blue-main); font-weight: 700; }

        .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .item-card { background: rgba(255,255,255,0.03); border-radius: 25px; padding: 20px; border: 1px solid var(--glass-border); }
        
        .edit-field-inline { width: 100%; border: none; background: transparent; padding: 4px; font-family: inherit; font-size: 0.7rem; color: white; border-bottom: 1px solid transparent; transition: 0.3s; outline: none; }
        .edit-field-inline:focus { border-bottom: 1px solid var(--barber-blue-main); background: rgba(255,255,255,0.05); }

        .prof-photo-circle { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--barber-blue-main); object-fit: cover; margin-bottom: 10px; }

        @media (max-width: 1100px) { .kanban-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .kanban-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div class="logo-text" style="margin-bottom: 25px;">RENATUS ADMIN</div>
            <button onclick="login()" style="background: var(--barber-blue-main); color: white; border: none; padding: 12px 30px; border-radius: 15px; font-weight: 700; cursor: pointer;">ACESSAR PAINEL</button>
        </div>
    </div>

    <div id="dash-content">
        <header class="header">
            <div class="logo-text">RENATUS BARBER DASH</div>
            <div style="text-align: right">
                <p id="adm-user" style="font-size: 0.8rem; font-weight: 700;">Admin</p>
                <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--barber-blue-main); font-size:0.6rem; font-weight:800; cursor:pointer;">IR PARA O SITE</button>
            </div>
        </header>

        <div class="kpi-grid">
            <div class="card-rb kpi-card"><span class="kpi-label">Faturamento Total</span><span id="kpi-total" class="kpi-value">R$ 0,00</span></div>
            <div class="card-rb kpi-card"><span class="kpi-label">Ticket Médio</span><span id="kpi-ticket" class="kpi-value">R$ 0,00</span></div>
            <div class="card-rb kpi-card"><span class="kpi-label">Ativos</span><span id="kpi-prod" class="kpi-value">0</span></div>
            <div class="card-rb kpi-card"><span class="kpi-label">Destaque</span><span id="kpi-top-client" class="kpi-value">---</span></div>
        </div>

        <div class="card-rb">
            <h3 class="section-title">Fluxo de Atendimento</h3>
            <div class="kanban-container">
                <div class="kanban-column" id="col-pendente-box" ondragover="allowDrop(event)" ondragleave="clearDrag(event)" ondrop="drop(event, 'pendente')">
                    <div class="col-header"><div class="col-dot" style="background:#666"></div> Agendado</div>
                    <div id="col-pendente"></div>
                </div>
                <div class="kanban-column" id="col-atrasado-box">
                    <div class="col-header"><div class="col-dot" style="background:var(--warning)"></div> Atrasado (+10m)</div>
                    <div id="col-atrasado"></div>
                </div>
                <div class="kanban-column" id="col-finalizado-box" ondragover="allowDrop(event)" ondragleave="clearDrag(event)" ondrop="drop(event, 'finalizado')">
                    <div class="col-header"><div class="col-dot" style="background:var(--success)"></div> Realizado</div>
                    <div id="col-finalizado"></div>
                </div>
                <div class="kanban-column" id="col-desmarcado-box" ondragover="allowDrop(event)" ondragleave="clearDrag(event)" ondrop="drop(event, 'desmarcado')">
                    <div class="col-header"><div class="col-dot" style="background:var(--danger)"></div> Desmarcado</div>
                    <div id="col-desmarcado"></div>
                </div>
            </div>
        </div>

        <div class="card-rb">
            <h3 class="section-title">Profissionais (Equipe)</h3>
            <button onclick="addProfissional()" style="background:var(--barber-blue-main); border:none; color:white; padding:8px 15px; border-radius:10px; font-size:0.6rem; font-weight:700; cursor:pointer; margin-bottom:20px">+ NOVO PROFISSIONAL</button>
            <div id="grid-equipe" class="stock-grid"></div>
        </div>

        <div class="card-rb">
            <h3 class="section-title">Gestão de Serviços</h3>
            <div id="grid-servicos" class="stock-grid"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAEG84kLya9LIK7TwAjsAxbP_FxcW4TGO4",
            authDomain: "renatus-4ecbf.firebaseapp.com",
            databaseURL: "https://renatus-4ecbf-default-rtdb.firebaseio.com",
            projectId: "renatus-4ecbf",
            storageBucket: "renatus-4ecbf.firebasestorage.app",
            messagingSenderId: "1022949355642",
            appId: "1:1022949355642:web:70055d55204e1932becbc3"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), database = firebase.database();
        const ADM_EMAIL = "pablo11ssousa2@gmail.com";
        let allBookings = {};

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

        auth.onAuthStateChanged(user => {
            if(user && user.email === ADM_EMAIL) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('adm-user').innerText = user.displayName;
                iniciarEscutas();
            }
        });

        function iniciarEscutas() {
            database.ref('renatus_bookings').on('value', snap => {
                allBookings = snap.val() || {};
                renderPedidos(Object.values(allBookings));
                recalcularGestao();
            });
            database.ref('renatus_services').on('value', snap => renderServicos(snap.val() || {}));
            database.ref('renatus_barbers').on('value', snap => renderEquipe(snap.val() || {}));
            setInterval(() => renderPedidos(Object.values(allBookings)), 60000);
        }

        // --- FUNÇÕES DE ARRASTAR E SOLTAR (DRAG & DROP) ---
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function clearDrag(ev) {
            ev.currentTarget.classList.remove('drag-over');
        }

        function drag(ev, bookingId) {
            ev.dataTransfer.setData("bookingId", bookingId);
        }

        function drop(ev, newStatus) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const id = ev.dataTransfer.getData("bookingId");
            if (id) updateStatus(id, newStatus);
        }

        // --- ATUALIZAÇÃO DE STATUS E DISPONIBILIDADE ---
        function updateStatus(id, newStatus) {
            const booking = allBookings[id];
            if (!booking) return;

            // Se desmarcar, removemos a trava do horário/barbeiro no banco se necessário
            if (newStatus === 'desmarcado') {
                // Aqui você pode adicionar lógica para apagar o registro ou liberar o nó de agenda
                // Por enquanto, apenas mudamos o status para permitir visualização histórica
                database.ref(`renatus_bookings/${id}`).update({ status: 'desmarcado' });
            } else {
                database.ref(`renatus_bookings/${id}`).update({ status: newStatus });
            }
        }

        function renderPedidos(pedidosArray) {
            const cols = { 
                pendente: document.getElementById('col-pendente'), 
                atrasado: document.getElementById('col-atrasado'), 
                finalizado: document.getElementById('col-finalizado'),
                desmarcado: document.getElementById('col-desmarcado')
            };
            Object.values(cols).forEach(c => c.innerHTML = "");

            const agora = new Date();

            pedidosArray.reverse().forEach(p => {
                const id = Object.keys(allBookings).find(key => allBookings[key].token === p.token);
                let st = p.status || 'pendente';

                if (st === 'pendente' && p.time) {
                    const [h, m] = p.time.split(':');
                    const agendado = new Date();
                    agendado.setHours(h, m, 0);
                    if ((agora - agendado) > 600000) st = 'atrasado';
                }

                const card = document.createElement('div');
                card.className = 'pedido-card';
                card.draggable = true;
                card.ondragstart = (e) => drag(e, id);
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start">
                        <span class="client-name">${p.clientName}</span>
                        <span class="time-tag">${p.time || '--:--'}</span>
                    </div>
                    <span style="font-size:0.6rem; opacity:0.6">${p.items ? p.items[0].name : 'Serviço'}</span>
                    <select class="status-select" onchange="updateStatus('${id}', this.value)">
                        <option value="pendente" ${st==='pendente'?'selected':''}>Agendado</option>
                        <option value="finalizado" ${st==='finalizado'?'selected':''}>Realizado</option>
                        <option value="desmarcado" ${st==='desmarcado'?'selected':''}>Desmarcado</option>
                    </select>
                `;
                
                if(cols[st]) cols[st].appendChild(card);
            });
        }

        // --- DEMAIS FUNÇÕES DE GESTÃO (MANTIDAS) ---
        function renderEquipe(data) {
            let html = "";
            Object.entries(data).forEach(([id, b]) => {
                html += `
                    <div class="item-card" style="text-align:center">
                        <img src="${b.photo || 'https://cdn-icons-png.flaticon.com/512/147/147144.png'}" class="prof-photo-circle">
                        <input type="text" value="${b.name}" class="edit-field-inline" style="text-align:center; font-weight:800; color:var(--barber-blue-main)" onchange="updateDB('renatus_barbers/${id}', 'name', this)">
                        <input type="text" value="${b.photo || ''}" placeholder="URL da Foto" class="edit-field-inline" style="font-size:0.5rem; opacity:0.5" onchange="updateDB('renatus_barbers/${id}', 'photo', this)">
                        <button onclick="remover('renatus_barbers/${id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:0.6rem; margin-top:10px">REMOVER</button>
                    </div>`;
            });
            document.getElementById('grid-equipe').innerHTML = html || '<p style="opacity:0.5; font-size:0.7rem">Nenhum profissional cadastrado.</p>';
        }

        function renderServicos(data) {
            let html = "";
            Object.entries(data).forEach(([id, s]) => {
                html += `
                    <div class="item-card">
                        <input type="text" value="${s.name}" class="edit-field-inline" style="font-weight:800; color:var(--barber-blue-main)" onchange="updateDB('renatus_services/${id}', 'name', this)">
                        <input type="number" value="${s.price}" class="edit-field-inline" style="font-size:0.9rem" onchange="updateDB('renatus_services/${id}', 'price', this, true)">
                        <input type="text" value="${s.barbers}" class="edit-field-inline" style="font-size:0.55rem; opacity:0.5" onchange="updateDB('renatus_services/${id}', 'barbers', this)">
                    </div>`;
            });
            document.getElementById('grid-servicos').innerHTML = html;
        }

        function updateDB(path, key, element, isNum = false) {
            let val = isNum ? (parseFloat(element.value) || 0) : element.value;
            database.ref(path).update({ [key]: val });
        }

        function recalcularGestao() {
            const arr = Object.values(allBookings);
            const fin = arr.filter(p => p.status === 'finalizado');
            const total = fin.reduce((acc, p) => acc + (p.total || 0), 0);
            document.getElementById('kpi-total').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('kpi-prod').innerText = arr.filter(p => p.status === 'pendente' || p.status === 'atrasado').length;
        }

        function addProfissional() {
            const newRef = database.ref('renatus_barbers').push();
            newRef.set({ name: "Novo Barbeiro", photo: "" });
        }

        function remover(path) { if(confirm("Deseja remover?")) database.ref(path).remove(); }
    </script>
</body>
</html>
