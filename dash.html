<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Renatus Barber | Executive Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --barber-blue-main: #007bff;
            --barber-bg: #1a1c1e;
            --barber-text: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --font-sans: 'Montserrat', sans-serif;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --info: #007bff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--barber-bg); font-family: var(--font-sans); color: var(--barber-text); padding-bottom: 50px; }

        #login-screen { position: fixed; inset: 0; background: rgba(26, 28, 30, 0.98); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .login-card { background: var(--barber-bg); padding: 50px; border-radius: 40px; box-shadow: 20px 20px 60px var(--shadow-dark); text-align: center; border: 1px solid var(--glass-border); }

        #dash-content { display: block; padding: 30px 5%; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .logo-text { font-weight: 800; font-size: 1.2rem; color: var(--barber-blue-main); letter-spacing: 2px; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }

        .card-rb { 
            background: var(--glass-bg); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 35px; 
            box-shadow: 12px 12px 24px var(--shadow-dark);
            margin-bottom: 30px; border: 1px solid var(--glass-border);
        }

        .kpi-card { padding: 20px; text-align: center; }
        .kpi-value { font-size: 1.2rem; font-weight: 700; color: var(--barber-blue-main); display: block; margin-top: 5px; }
        .kpi-label { font-size: 0.55rem; font-weight: 800; opacity: 0.5; text-transform: uppercase; letter-spacing: 1px; }

        .section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--barber-blue-main); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: ''; width: 4px; height: 15px; background: var(--barber-blue-main); border-radius: 2px; }

        .date-management-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .config-input { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 10px; border-radius: 10px; width: 100%; margin-top: 5px; outline: none; font-family: inherit; }
        .blocked-date-item { display: flex; justify-content: space-between; align-items: center; background: rgba(231, 76, 60, 0.1); padding: 8px 15px; border-radius: 10px; margin-bottom: 5px; font-size: 0.7rem; border: 1px solid rgba(231, 76, 60, 0.2); }

        .kanban-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; align-items: start; }
        .kanban-column { background: rgba(255,255,255,0.02); border-radius: 25px; padding: 15px; min-height: 500px; border: 1px solid var(--glass-border); transition: background 0.3s; }
        .kanban-column.drag-over { background: rgba(255,255,255,0.08); }
        
        .col-header { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; color: #fff; margin-bottom: 15px; text-align: center; display: flex; justify-content: center; align-items: center; gap: 8px; position: sticky; top: 0; background: inherit; z-index: 1; padding: 5px 0; }
        .col-dot { width: 8px; height: 8px; border-radius: 50%; }

        .pedido-card { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 15px; margin-bottom: 12px; border: 1px solid var(--glass-border); cursor: grab; transition: transform 0.2s; position: relative; }
        .pedido-card:active { cursor: grabbing; transform: scale(0.95); }
        
        .status-select { padding: 8px; border-radius: 10px; border: none; font-size: 0.55rem; font-weight: 800; text-transform: uppercase; cursor: pointer; width: 100%; background: #2a2c2e; color: #fff; margin-top: 10px; }
        
        .client-name { font-size: 0.75rem; font-weight: 700; display: block; margin-bottom: 3px; }
        .time-tag { font-size: 0.6rem; color: var(--barber-blue-main); font-weight: 700; }
        .barber-tag { font-size: 0.5rem; opacity: 0.5; display: block; margin-top: 2px; }

        .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .item-card { background: rgba(255,255,255,0.03); border-radius: 25px; padding: 20px; border: 1px solid var(--glass-border); }
        
        .edit-field-inline { width: 100%; border: none; background: transparent; padding: 4px; font-family: inherit; font-size: 0.7rem; color: white; border-bottom: 1px solid transparent; transition: 0.3s; outline: none; }
        .edit-field-inline:focus { border-bottom: 1px solid var(--barber-blue-main); background: rgba(255,255,255,0.05); }

        .prof-photo-circle { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--barber-blue-main); object-fit: cover; margin-bottom: 10px; }

        @media (max-width: 1100px) { .kanban-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .kanban-container { grid-template-columns: 1fr; } .date-management-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div class="logo-text" style="margin-bottom: 25px;">RENATUS ADMIN</div>
            <button onclick="login()" style="background: var(--barber-blue-main); color: white; border: none; padding: 12px 30px; border-radius: 15px; font-weight: 700; cursor: pointer;">ACESSAR PAINEL</button>
        </div>
    </div>

    <div id="dash-content">
        <header class="header">
            <div class="logo-text">RENATUS BARBER DASH</div>
            <div style="text-align: right">
                <p id="adm-user" style="font-size: 0.8rem; font-weight: 700;">Admin</p>
                <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--barber-blue-main); font-size:0.6rem; font-weight:800; cursor:pointer;">IR PARA O SITE</button>
            </div>
        </header>

        <div class="kpi-grid">
            <div class="card-rb kpi-card"><span class="kpi-label">Faturamento Total</span><span id="kpi-total" class="kpi-value">R$ 0,00</span></div>
            <div class="card-rb kpi-card"><span class="kpi-label">Ticket Médio</span><span id="kpi-ticket" class="kpi-value">R$ 0,00</span></div>
            <div class="card-rb kpi-card"><span class="kpi-label">Ativos</span><span id="kpi-prod" class="kpi-value">0</span></div>
            <div class="card-rb kpi-card"><span class="kpi-label">Destaque</span><span id="kpi-top-client" class="kpi-value">---</span></div>
        </div>

        <div class="card-rb">
            <h3 class="section-title">Gestão de Calendário (Configurações do Site)</h3>
            <div class="date-management-grid">
                <div>
                    <label style="font-size: 0.6rem; font-weight: 800; opacity: 0.5;">DURANTE QUANTOS DIAS O CLIENTE PODE AGENDAR?</label>
                    <input type="number" id="config-days-range" class="config-input" onchange="updateConfig('daysRange', this.value)">
                    <p style="font-size: 0.5rem; opacity: 0.4; margin-top: 5px;">Define o limite de dias futuros visíveis no site.</p>
                </div>
                <div>
                    <label style="font-size: 0.6rem; font-weight: 800; opacity: 0.5;">BLOQUEAR DATAS ESPECÍFICAS (FOLGAS/FERIADOS)</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <input type="date" id="block-date-input" class="config-input" style="margin-top:0">
                        <button onclick="addBlockedDate()" style="background: var(--danger); color: white; border: none; padding: 0 20px; border-radius: 10px; font-weight: 700; font-size: 0.6rem; cursor: pointer;">BLOQUEAR</button>
                    </div>
                    <div id="blocked-dates-list" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;"></div>
                </div>
            </div>
        </div>

        <div class="card-rb">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="section-title" style="margin-bottom: 0;">Fluxo de Atendimento</h3>
                <input type="date" id="dash-date-filter" style="background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); color:white; padding:8px; border-radius:10px; font-family:inherit; font-size:0.7rem;" onchange="renderPedidos(Object.values(allBookings))">
            </div>
            <div class="kanban-container">
                <div class="kanban-column" id="col-pendente-box" ondragover="allowDrop(event)" ondragleave="clearDrag(event)" ondrop="drop(event, 'pendente')">
                    <div class="col-header"><div class="col-dot" style="background:#666"></div> Agendado</div>
                    <div id="col-pendente"></div>
                </div>
                <div class="kanban-column" id="col-atrasado-box">
                    <div class="col-header"><div class="col-dot" style="background:var(--warning)"></div> Atrasado (+10m)</div>
                    <div id="col-atrasado"></div>
                </div>
                <div class="kanban-column" id="col-finalizado-box" ondragover="allowDrop(event)" ondragleave="clearDrag(event)" ondrop="drop(event, 'finalizado')">
                    <div class="col-header"><div class="col-dot" style="background:var(--success)"></div> Realizado</div>
                    <div id="col-finalizado"></div>
                </div>
                <div class="kanban-column" id="col-desmarcado-box" ondragover="allowDrop(event)" ondragleave="clearDrag(event)" ondrop="drop(event, 'desmarcado')">
                    <div class="col-header"><div class="col-dot" style="background:var(--danger)"></div> Desmarcado</div>
                    <div id="col-desmarcado"></div>
                </div>
            </div>
        </div>

        <div class="card-rb">
            <h3 class="section-title">Profissionais (Equipe)</h3>
            <button onclick="addProfissional()" style="background:var(--barber-blue-main); border:none; color:white; padding:8px 15px; border-radius:10px; font-size:0.6rem; font-weight:700; cursor:pointer; margin-bottom:20px">+ NOVO PROFISSIONAL</button>
            <div id="grid-equipe" class="stock-grid"></div>
        </div>

        <div class="card-rb">
            <h3 class="section-title">Gestão de Serviços</h3>
            <div id="grid-servicos" class="stock-grid"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAEG84kLya9LIK7TwAjsAxbP_FxcW4TGO4",
            authDomain: "renatus-4ecbf.firebaseapp.com",
            databaseURL: "https://renatus-4ecbf-default-rtdb.firebaseio.com",
            projectId: "renatus-4ecbf",
            storageBucket: "renatus-4ecbf.firebasestorage.app",
            messagingSenderId: "1022949355642",
            appId: "1:1022949355642:web:70055d55204e1932becbc3"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), database = firebase.database();
        const ADM_EMAIL = "pablo11ssousa2@gmail.com";
        let allBookings = {};

        document.getElementById('dash-date-filter').value = new Date().toISOString().split('T')[0];

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

        auth.onAuthStateChanged(user => {
            if(user && user.email === ADM_EMAIL) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('adm-user').innerText = user.displayName;
                iniciarEscutas();
            }
        });

        function iniciarEscutas() {
            database.ref('renatus_bookings').on('value', snap => {
                allBookings = snap.val() || {};
                renderPedidos(Object.values(allBookings));
                recalcularGestao();
            });
            database.ref('renatus_services').on('value', snap => renderServicos(snap.val() || {}));
            database.ref('renatus_barbers').on('value', snap => renderEquipe(snap.val() || {}));
            
            // Ouvir configurações de data
            database.ref('renatus_config').on('value', snap => {
                const config = snap.val() || {};
                document.getElementById('config-days-range').value = config.daysRange || 7;
                renderBlockedDates(config.blockedDates || {});
            });

            setInterval(() => renderPedidos(Object.values(allBookings)), 60000);
        }

        // --- GESTÃO DE CONFIGURAÇÕES DE DATA ---
        function updateConfig(key, val) {
            const cleanVal = key === 'daysRange' ? parseInt(val) : val;
            database.ref('renatus_config').update({ [key]: cleanVal }).catch(e => console.error("Erro Firebase:", e));
        }

        function addBlockedDate() {
            const date = document.getElementById('block-date-input').value;
            if(!date) return;
            const dateId = date.replace(/-/g, '');
            database.ref(`renatus_config/blockedDates/${dateId}`).set(date).catch(e => console.error("Erro Firebase:", e));
        }

        function removeBlockedDate(dateId) {
            database.ref(`renatus_config/blockedDates/${dateId}`).remove().catch(e => console.error("Erro Firebase:", e));
        }

        function renderBlockedDates(dates) {
            const list = document.getElementById('blocked-dates-list');
            list.innerHTML = "";
            Object.entries(dates).forEach(([id, date]) => {
                const d = new Date(date + "T00:00:00").toLocaleDateString('pt-BR');
                list.innerHTML += `
                    <div class="blocked-date-item">
                        <span>${d}</span>
                        <button onclick="removeBlockedDate('${id}')" style="background:none; border:none; color:white; font-weight:700; cursor:pointer;">&times;</button>
                    </div>`;
            });
        }

        // --- KANBAN E DRAG & DROP ---
        function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        function clearDrag(ev) { ev.currentTarget.classList.remove('drag-over'); }
        function drag(ev, bookingId) { ev.dataTransfer.setData("bookingId", bookingId); }
        function drop(ev, newStatus) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const id = ev.dataTransfer.getData("bookingId");
            if (id) database.ref(`renatus_bookings/${id}`).update({ status: newStatus });
        }

        function renderPedidos(pedidosArray) {
            const cols = { 
                pendente: document.getElementById('col-pendente'), 
                atrasado: document.getElementById('col-atrasado'), 
                finalizado: document.getElementById('col-finalizado'),
                desmarcado: document.getElementById('col-desmarcado')
            };
            Object.values(cols).forEach(c => c.innerHTML = "");

            const selectedDate = document.getElementById('dash-date-filter').value;
            const agora = new Date();
            const hojeStr = agora.toISOString().split('T')[0];

            pedidosArray.reverse().forEach(p => {
                const dataPedido = p.scheduleDate || p.date.split('T')[0];
                if (dataPedido !== selectedDate) return;

                const id = Object.keys(allBookings).find(key => allBookings[key].token === p.token);
                let st = p.status || 'pendente';

                if (st === 'pendente' && p.time && selectedDate === hojeStr) {
                    const [h, m] = p.time.split(':');
                    const agendado = new Date();
                    agendado.setHours(h, m, 0);
                    if ((agora - agendado) > 600000) st = 'atrasado';
                }

                const card = document.createElement('div');
                card.className = 'pedido-card';
                card.draggable = true;
                card.ondragstart = (e) => drag(e, id);
                
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start">
                        <span class="client-name">${p.clientName}</span>
                        <span class="time-tag">${p.time || '--:--'}</span>
                    </div>
                    <span style="font-size:0.6rem; opacity:0.8; font-weight:600">${p.items ? p.items[0].name : 'Serviço'}</span>
                    <span class="barber-tag">Profissional: ${p.items ? p.items[0].barber : '---'}</span>
                    <select class="status-select" onchange="database.ref('renatus_bookings/${id}').update({status: this.value})">
                        <option value="pendente" ${st==='pendente'?'selected':''}>Agendado</option>
                        <option value="finalizado" ${st==='finalizado'?'selected':''}>Realizado</option>
                        <option value="desmarcado" ${st==='desmarcado'?'selected':''}>Desmarcado</option>
                    </select>
                `;
                if(cols[st]) cols[st].appendChild(card);
            });
        }

        function renderEquipe(data) {
            let html = "";
            Object.entries(data).forEach(([id, b]) => {
                html += `
                    <div class="item-card" style="text-align:center">
                        <img src="${b.photo || 'https://cdn-icons-png.flaticon.com/512/147/147144.png'}" class="prof-photo-circle">
                        <input type="text" value="${b.name}" class="edit-field-inline" style="text-align:center; font-weight:800; color:var(--barber-blue-main)" onchange="database.ref('renatus_barbers/${id}').update({name: this.value})">
                        <input type="text" value="${b.photo || ''}" placeholder="URL da Foto" class="edit-field-inline" style="font-size:0.5rem; opacity:0.5" onchange="database.ref('renatus_barbers/${id}').update({photo: this.value})">
                        <button onclick="if(confirm('Remover?')) database.ref('renatus_barbers/${id}').remove()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:0.6rem; margin-top:10px">REMOVER</button>
                    </div>`;
            });
            document.getElementById('grid-equipe').innerHTML = html;
        }

        function renderServicos(data) {
            let html = "";
            Object.entries(data).forEach(([id, s]) => {
                html += `
                    <div class="item-card">
                        <input type="text" value="${s.name}" class="edit-field-inline" style="font-weight:800; color:var(--barber-blue-main)" onchange="database.ref('renatus_services/${id}').update({name: this.value})">
                        <input type="number" value="${s.price}" class="edit-field-inline" style="font-size:0.9rem" onchange="database.ref('renatus_services/${id}').update({price: parseFloat(this.value)})">
                        <input type="text" value="${s.barbers}" class="edit-field-inline" style="font-size:0.55rem; opacity:0.5" onchange="database.ref('renatus_services/${id}').update({barbers: this.value})">
                    </div>`;
            });
            document.getElementById('grid-servicos').innerHTML = html;
        }

        function recalcularGestao() {
            const arr = Object.values(allBookings);
            const total = arr.filter(p => p.status === 'finalizado').reduce((acc, p) => acc + (p.total || 0), 0);
            document.getElementById('kpi-total').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('kpi-prod').innerText = arr.filter(p => p.status === 'pendente' || p.status === 'atrasado').length;
        }

        function addProfissional() { database.ref('renatus_barbers').push({ name: "Novo Barbeiro", photo: "" }); }
    </script>
</body>
</html>
